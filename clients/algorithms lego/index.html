<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>algorithms lego V3</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
/* ---------------------------------------------------- */
/* --- CORE LAYOUT & RESET (ENSURING 100% VIEWPORT HEIGHT) --- */
/* ---------------------------------------------------- */
html,body{
    height:100vh; /* Set html and body to 100% of viewport height */
    margin:0;
}
body{
    background:#000;
    display:flex; /* Use flex to ensure .container takes up space */
    font-family:Arial, Helvetica, sans-serif;
    overflow:hidden; /* Crucial: Prevents main browser window scroll */
    flex-direction: column; /* Allows content below container (like hidden elements) to stack */
}
.container{
    display:flex;
    height:100%; /* Takes 100% of the body's 100vh height */
    width:100%;
}

/* --- Ø§Ù„Ø£Ù„ÙˆØ§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
.left-panel{
 width:30%; background:#111; color:#0f0; padding:15px;
 font-family:monospace; font-size:8px; overflow-y:auto; white-space:pre-wrap;
 display:flex; flex-direction:column; 
}
.right-panel{
    flex:1; 
    position:relative;
    overflow-y:auto; /* Ensures scrolling within the panel for content + footer */
    height:100%; /* Takes 100% of the body's 100vh height */
    padding-bottom: 50px; /* Optional: Adds some space after the footer */
}
.stage{
    position:relative;
    width:100%;
    /* Must use min-height to ensure the stage content dictates the panel scroll length */
    min-height: calc(100vh - 100px); /* Ensures stage takes at least the viewport height */
}

/* ---------------------------------------------------- */
/* --- FOOTER STYLES (Positioned at bottom of scrollable content) --- */
/* ---------------------------------------------------- */
main{
    /* min-height:60vh is kept to ensure the grid/main section has size */ 
    width: 100%;
}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
footer{margin-top:18px;color:#aaa;font-size:13px} /* Using static color for visibility */
.footer{
    border-top:1px solid rgba(255,255,255,0.05);
    padding:24px 10px;
    text-align:center;
    color:#aaa;
    font-size:13px;
}
.footer-row{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:8px}
.footer-links{display:flex;gap:12px;flex-wrap:wrap}
.footer-links a{color:#aaa;text-decoration:none;transition:color 0.2s ease}
.footer-links a:hover{color:#6ab4ff;} 
.lang-select{background:none;border:none;color:#aaa;font-size:13px;cursor:pointer;padding:4px 6px}
.footer-copy{font-size:12px;opacity:0.8}

/* ---------------------------------------------------- */
/* --- REST OF STYLES (Unchanged) --- */
/* ---------------------------------------------------- */
.inspector-panel{
 position:fixed; 
 width: 130px; 
 height: 200px; 
 background:rgba(255,255,255,0.1); backdrop-filter:blur(3px);
 color:#fff; 
 padding:5px; 
 box-sizing:border-box;
 z-index:2000; 
 display:none; 
 flex-direction:column; 
 gap: 2px; 
 border:1px solid #333;
 overflow: hidden; 
}
.inspector-panel.active{display:flex;}
.inspector-panel label{
 font-size:8px; 
 color:#aaa;
}
.inspector-panel input, .inspector-panel select, .inspector-panel textarea {
 padding:2px; 
 border:1px solid #444; 
 background:#333; 
 color:#fff; 
 border-radius:3px;
 width:100%; 
 box-sizing:border-box; 
 font-size:8px; 
 min-height: 10px; 
}
.inspector-panel textarea{
 height: 30px; 
 resize:none;
}
.inspector-panel button{
 padding: 2px 4px; 
 border:none;
 background:#444;
 color:#fff;
 cursor:pointer;
 border-radius:3px;
 font-size: 8px; 
}
.inspector-panel button:hover {
 background:#555;
}
.square{
 width:auto; height:auto; position:absolute; user-select:none; touch-action:none;
 transition:box-shadow 120ms; display:flex; min-width:30px; min-height:30px; max-width:250px;
 justify-content:center;align-items:center; color:#fff; font-size:8px;
 padding:4px 8px; text-align:center; cursor:grab; box-sizing:border-box;
 overflow-wrap:break-word;
}
.square[data-type="end"]{background:#ff3b3b;box-shadow:0 0 25px #ff3b3bee}
.square[data-type="read"], .square[data-type="write"]{background:#4da6ff;box-shadow:0 0 25px #4da6ffee}
.square[data-type="start"]{background:#4fff5a;box-shadow:0 0 25px #4fff5acc}
.square[data-type="algorithm"]{background:#c45bff;box-shadow:0 0 25px #c45bffcc}
.square[data-type="variable"]{background:#fff37a;color:#222;box-shadow:0 0 25px #fff37acc}
.square[data-type="constant"]{background:#ff7ab8;box-shadow:0 0 25px #ff7ab8cc}
.square[data-type="process"]{background:#ff8c00;box-shadow:0 0 25px #ff8c00cc}
.square[data-type="decision"]{background:#00ffaacc;box-shadow:0 0 25px #19f0a8cc;} 
.square[data-type="loop"]{background:#141414cc;box-shadow:0 0 25px #484848cc;} 
.square[contenteditable="true"]{
 outline:2px solid #6ab4ff; box-shadow:0 0 20px #6ab4ff; cursor:text;
}
.square.selected{
 outline:3px dashed rgba(255, 255, 255, 0.263);
}
.link-line{
 position:absolute; background:#fff; z-index:500; pointer-events:none; opacity:0.6;
}
.selection-box{
 position:absolute; border:1px dashed rgba(255,255,255,0.8);
 background:rgba(255,255,255,0.1); backdrop-filter:blur(3px);
 z-index:999; pointer-events:none;
}
.controls-bar{
 position:absolute;left:215px;top:12px;z-index:1000;
 display:flex;gap:5px;
}
.controls-bar button, 
.data-controls button, 
.controls-bar select,
.data-controls select,
.left-panel select {
    text-decoration: none;
    border: none;
    background: #333;
    box-shadow: 0 0 10px #ffffff22;
    color: #fff;
    cursor: pointer;
    font-size: 8px;
    padding: 6px 8px;
    height: 24px;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 60px;
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    transition: all 0.2s ease;
}
.controls-bar button:hover, 
.data-controls button:hover, 
.left-panel button:hover,
.controls-bar select:hover,
.data-controls select:hover,
.left-panel select:hover {
    outline: 2px solid #6ab4ff; 
    box-shadow: 0 0 10px #6ab4ff;
    background: #444;
}
.hint{position:fixed;left:12px;bottom:12px;color:#ddd;opacity:0.7;font-size:13px;}
#codeOutput{white-space:pre-wrap; color:#0f0;}
.left-panel #js {
    text-decoration: none;
    border: none;
    background: #ffc400;
    box-shadow: 0 0 10px #ffffff22;
    color: #fff;
    cursor: pointer;
    font-size: 8px;
    padding: 6px 6px;
    height: 24px;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 30px;
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    transition: all 0.2s ease;
}
.left-panel #py {
    text-decoration: none;
    border: none;
    background: #0080ff;
    box-shadow: 0 0 10px #ffffff22;
    color: #fff;
    cursor: pointer;
    font-size: 8px;
    padding: 6px 6px;
    height: 24px;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 30px;
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    transition: all 0.2s ease;
}
/* === Popup Background (hidden by default) === */
#popupBackground {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none; /* Hidden initially */
    justify-content: center;
    align-items: center;
    color: white;
    /* Blur effect */
    backdrop-filter: blur(3px);
}

/* === Popup Box === */
#popupBox {
    background:rgba(255,255,255,0.1);
    padding: 20px;
    width: 300px;
    text-align: center;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
}

/* === My Projects List Styles === */
#myProjectsList {
    list-style: none;
    padding: 0;
    margin-top: 20px;
}
.project-item {
    background: #222;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #333;
}
.project-item:hover {
    background: #333;
    border-color: #6ab4ff;
}
.project-title {
    color: #fff;
    font-size: 10px;
    font-weight: bold;
    flex-grow: 1;
}
.project-thumb {
    width: 50px;
    height: 30px;
    background-size: cover;
    background-position: center;
    border: 1px solid #555;
    margin-left: 10px;
}
.project-load-btn {
    background: #0080ff;
    color: white;
    border: none;
    padding: 4px 8px;
    font-size: 8px;
    margin-left: 5px;
    cursor: pointer;
    border-radius: 3px;
}
.project-delete-btn {
    background: #ff3b3b;
    color: white;
    border: none;
    padding: 4px 8px;
    font-size: 8px;
    margin-left: 5px;
    cursor: pointer;
    border-radius: 3px;
}

/* === Save Project Modal Styles === */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 3000;
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: #222;
    padding: 20px;
    border-radius: 8px;
    width: 300px;
}
.modal-content h3 {
    color: #fff;
    margin-top: 0;
}
.modal-content input {
    width: 100%;
    padding: 8px;
    margin: 10px 0;
    background: #333;
    border: 1px solid #444;
    color: #fff;
    border-radius: 4px;
    box-sizing: border-box;
}
.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 15px;
}
.modal-buttons button {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}
#saveProjectBtn {
    background: #0080ff;
    color: white;
}
#cancelSaveBtn {
    background: #666;
    color: white;
}

</style>
</head>
<body>

<div class="inspector-panel" id="inspectorPanel">
    <h3>inspector</h3>
    <label for="boxType">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø¨Ø¹:</label>
    <select id="boxType" onchange="updateBoxType(this.value)">
        <option value="process">Ø¥Ø¬Ø±Ø§Ø¡ (Process)</option>
        <option value="read">Ù‚Ø±Ø§Ø¡Ø© (Read)</option>
        <option value="write">ÙƒØªØ§Ø¨Ø© (Write)</option>
        <option value="start">Ø¨Ø¯Ø§ÙŠØ© (Start)</option>
        <option value="end">Ù†Ù‡Ø§ÙŠØ© (End)</option>
        <option value="algorithm">Ø§Ø³Ù… Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©</option>
        <option value="variable">Ù…ØªØºÙŠØ±</option>
        <option value="constant">Ø«Ø§Ø¨Øª</option>
        <option value="decision">Ù‚Ø±Ø§Ø± (Decision) | if</option>
        <option value="decision">Ù‚Ø±Ø§Ø± (Decision) | else</option>
        <option value="loop">(loop) | for</option>
    </select>

    <label for="boxText">Ù†Øµ Ø§Ù„Ù…Ø±Ø¨Ø¹:</label>
    <textarea id="boxText" oninput="updateBoxText(this.value)"></textarea>
    <button id="makeElseBtn" style="margin-top:10px;width:100%;padding:8px;">
    Ø¬Ø¹Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙØ±Ø¹ ELSE Ù„Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
</button>
    <button onclick="disconnectSelected()">Ù‚Ø·Ø¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</button>
    <div style="flex-grow:1;"></div>
</div>

<!-- Save Project Modal -->
<div class="modal" id="saveModal">
    <div class="modal-content">
        <h3>ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
        <p style="color:#aaa; font-size:12px; margin-bottom:15px;">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ø­ÙØ¸Ù‡ Ù…Ø¹ ØµÙˆØ±Ø© Ù…ØµØºØ±Ø©:</p>
        <input type="text" id="projectNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" autocomplete="off">
        <div class="modal-buttons">
            <button id="cancelSaveBtn">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="saveProjectBtn">Ø­ÙØ¸</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="left-panel">
        <h3 style="color:#fff; border-bottom:1px solid #333; padding-bottom:5px;">ğŸ“‹ Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
        <ul id="myProjectsList">
            <!-- Projects will be loaded here -->
        </ul>
        <div style="margin-top: 20px;">
            <h3 style="color:#fff; border-bottom:1px solid #333; padding-bottom:5px;">ğŸ’» Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ø§ØªØ¬</h3>
            <div id="codeOutput">/* Ø§Ù„ÙƒÙˆØ¯ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ */</div>
        </div>
    </div>
    
    <div class="right-panel">
        <div class="stage" id="stage">
            <div class="square" data-type="end" style="left:calc(50% - 180px);top:calc(50% - 25px);">end</div>
            <div class="square" data-type="write" style="left:calc(50% + 130px);top:calc(50% - 25px);">write</div>
            <div class="square" data-type="read" style="left:20px;top:20px;">read</div>
            <div class="square" data-type="start" style="left:90px;top:100px;">start</div>
            <div class="square" data-type="algorithm" style="left:160px;top:180px;">algorithm: sum</div>
            <div class="square" data-type="variable" style="left:230px;top:260px;">x</div>
            <div class="square" data-type="constant" style="left:300px;top:320px;">PI = 3.14</div>
            <div class="square" data-type="process" style="left:400px;top:400px;">sum = x + 1</div>

            <div class="controls-bar">
                <button onclick="addBox()">+ Add Block</button>
                <button onclick="deleteSelected()">Delete</button>
                <button onclick="selectAll()">Select All</button>
                <button onclick="openSaveModal()">ğŸ“¸ Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø©</button>                 <div class="data-controls">
                    <button onclick="exportJSON()">ğŸ“¤ ØªØµØ¯ÙŠØ± JSON</button>
                    <input type="file" id="importFile" style="display:none;" onchange="importJSON(event)">
                    <button onclick="document.getElementById('importFile').click()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
                    <button onclick="takeShot()">Screenshot</button>
                </div>
            </div>
        </div>
        
        <main>
            <section class="grid" id="grid"></section>
            <div class="footer">
                <div class="footer-row">
                    <div class="footer-links">
                        <a href="about.php">About</a>
                        <a href="help.php">Help</a>
                        <a href="privacy.php">Privacy</a>
                        <a href="terms.php">Terms</a>
                    </div>
                    <select aria-label="Switch Display Language" class="lang-select" id="langSelect">
                        <option value="en" selected>English</option>
                        <option value="fr">FranÃ§ais</option>
                        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="es">EspaÃ±ol</option>
                    </select>
                </div>
                <div class="footer-copy">Â© 2025 Algorithms lego V3 â€” Somoud Baha-Ouramadan</div>
            </div>
        </main>
        
    </div>
</div>
<div id="popupBackground" style="display:none;">
    <div id="popupBox">
        <h2>Algorithms lego Map</h2>
        <p>
            <span style="background:#c45bff; box-shadow:0 0 25px #c45bffcc; padding:3px 6px;">algorithm</span>
            : write the name of algorithm
            <br><br>
            <span style="background:#4fff5a; box-shadow:0 0 25px #4fff5acc; padding:3px 6px;">start</span>
            : when you want to start
            <br><br>
            <span style="background:#fff37a; color:#222; box-shadow:0 0 25px #fff37acc; padding:3px 6px;">variables</span>
            : all of your variables; each one on its block
            <br><br>
            <span style="background:#ff7ab8; box-shadow:0 0 25px #ff7ab8cc; padding:3px 6px;">constants</span>
            : all of your constants; each one on its block
            <br><br>
            <span style="background:#00ffaacc; box-shadow:0 0 25px #19f0a8cc; padding:3px 6px;">if / else</span>
            : if you have any choice
            <br><br>
            <span style="background:#141414cc; color:white; box-shadow:0 0 25px #484848cc; padding:3px 6px;">for</span>
            : if you want to make loops
            <br><br>
            <span style="background:#ff8c00; box-shadow:0 0 25px #ff8c00cc; padding:3px 6px;">process</span>
            : when you have to write a calculation
            <br><br>
            <span style="background:#4da6ff; box-shadow:0 0 25px #4da6ffee; padding:3px 6px;">read</span>
            : ask the user to write something
            <br><br>
            <span style="background:#4da6ff; box-shadow:0 0 25px #4da6ffee; padding:3px 6px;">write</span>
            : the final result the user sees
            <br><br>
            <span style="background:#ff3b3b; box-shadow:0 0 25px #ff3b3bee; padding:3px 6px; color:white;">end</span>
            : when you finish
        </p>
        <button id="closePopup">Close</button>
    </div>
</div>

<script>
(function(){
/* -------------------------
   Ø¹Ù†Ø§ØµØ± DOM Ùˆ Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
   ------------------------- */
const stage = document.getElementById('stage');
const codeOutput = document.getElementById('codeOutput');
const inspectorPanel = document.getElementById('inspectorPanel');
const consolePanel = document.getElementById('consolePanel');
const boxTypeSelect = document.getElementById('boxType');
const boxTextarea = document.getElementById('boxText');
const myProjectsList = document.getElementById('myProjectsList');
const saveModal = document.getElementById('saveModal');
const projectNameInput = document.getElementById('projectNameInput');
const saveProjectBtn = document.getElementById('saveProjectBtn');
const cancelSaveBtn = document.getElementById('cancelSaveBtn');

let boxes = Array.from(document.querySelectorAll('.square'));
// links: Map sourceID -> Set of targetIDs (ÙŠØ¯Ø¹Ù… outgoing Ù…ØªØ¹Ø¯Ø¯Ø© Ù„ÙƒÙ„ Ù…ØµØ¯Ø±)
let links = new Map();
const SNAP = 60;
const DEBOUNCE_TIME = 150;
let dragging = null;
let selectedBoxes = [];
let groupOffsets = [];
let singleOffset = {x:0,y:0};
let isSelecting = false, selectionStart = {x:0,y:0}, selectionBox = null;
let lastSnapTime = 0;
let currentID = boxes.length || 0;
window._shiftKey = false;
window._ctrlKey = false;

// ØµÙˆØª Ø§Ù„Ø§Ù„ØªØµØ§Ù‚
const stickSound = new Audio("tap.mp3");
stickSound.volume = 0.3;

/* -------------------------
   Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
   ------------------------- */
function logToConsole(message, type='log'){
    const logElement = document.createElement('p');
    logElement.className = 'log ' + type;
    logElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    consolePanel.prepend(logElement);
    if (consolePanel.children.length > 200) consolePanel.removeChild(consolePanel.lastChild);
}

function px(v){ return Math.round(v) + "px"; }
function getPos(el){ return {x: parseFloat(getComputedStyle(el).left) || 0, y: parseFloat(getComputedStyle(el).top) || 0}; }
function getRect(el){ const p=getPos(el); return {left:p.x, top:p.y, right:p.x+el.offsetWidth, bottom:p.y+el.offsetHeight, width:el.offsetWidth, height:el.offsetHeight}; }
function getCenter(el){ const p=getPos(el); return {x: p.x + el.offsetWidth/2, y: p.y + el.offsetHeight/2}; }
function getID(el){ return el.id || (el.id = `box-${currentID++}`); }

/* -------------------------
   ØªØ­Ø¯ÙŠØ¯ / ØªÙØ±ÙŠØº Ø§Ù„ØªØ­Ø¯ÙŠØ¯
   ------------------------- */
function selectBox(el){
    if(!el) return;
    el.classList.add('selected');
    if(!selectedBoxes.includes(el)) selectedBoxes.push(el);
    updateInspector();
}
function clearSelection(){
    selectedBoxes.forEach(b=>b.classList.remove('selected'));
    selectedBoxes = [];
    inspectorPanel.classList.remove('active');
}

/* -------------------------
   ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­Ø±ÙŠØ±/Ø§Ù„ØªØ­Ø¬ÙŠÙ…
   ------------------------- */
function autoResize(el){
    el.style.width = "auto"; el.style.height = "auto";
    el.style.width = Math.min(el.scrollWidth, 250) + "px";
    el.style.height = el.scrollHeight + "px";
}
function enableAutoExpand(el){ el.addEventListener("input", ()=>autoResize(el)); autoResize(el); }

function startEditing(el){
    el.contentEditable = "true";
    el.focus();
    el.style.cursor = "text";
    el.classList.add('editing');

    const stopEditing = () => {
        el.contentEditable = "false";
        el.style.cursor = "grab";
        el.classList.remove('editing');
        generateCode();
        el.removeEventListener("blur", stopEditing);
        el.removeEventListener("keydown", handleKeydown);
    };

    const handleKeydown = (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            stopEditing();
        }
    };

    el.addEventListener("blur", stopEditing, {once:true});
    el.addEventListener("keydown", handleKeydown);
}

/* -------------------------
   Inspector panel
   ------------------------- */
function updateInspector(){
    if (selectedBoxes.length === 1){
        const el = selectedBoxes[0];
        const elRect = el.getBoundingClientRect();
        const inspectorWidth = inspectorPanel.offsetWidth || 200;
        const inspectorHeight = inspectorPanel.offsetHeight || (window.innerHeight * 0.5);
        let newLeft = elRect.right + 10;
        let newTop = elRect.top;
        if (newLeft + inspectorWidth > window.innerWidth){
            newLeft = elRect.left - inspectorWidth - 10;
            if (newLeft < 0) newLeft = elRect.right + 10;
        }
        if (newTop + inspectorHeight > window.innerHeight){
            newTop = window.innerHeight - inspectorHeight - 10;
        }
        inspectorPanel.style.left = `${newLeft}px`;
        inspectorPanel.style.top = `${newTop}px`;

        inspectorPanel.classList.add('active');
        // Ø§Ù„Ø¢Ù† Ù†Ù…Ù„Ø£ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø¨Ø¹ (Ù†Ø±Ø§Ø¹ÙŠ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
        boxTypeSelect.value = el.dataset.type || 'process';
        boxTextarea.value = el.textContent.trim();
        logToConsole(`Inspecting: ${el.textContent.trim()}`, 'status');
    } else {
        inspectorPanel.classList.remove('active');
    }
}

window.updateBoxType = function(type){
    if (selectedBoxes.length === 1){
        const el = selectedBoxes[0];
        el.dataset.type = type;
        generateCode();
        logToConsole(`Block type set to ${type}`, 'status');
    }
}

window.updateBoxText = function(text){
    if (selectedBoxes.length === 1){
        const el = selectedBoxes[0];
        el.textContent = text;
        autoResize(el);
        generateCode();
    }
}

window.disconnectSelected = function(){
    if (selectedBoxes.length === 1){
        const id = getID(selectedBoxes[0]);
        // Ø­Ø°Ù Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø®Ø§Ø±Ø¬Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø¨Ø¹
        links.delete(id);
        // Ø­Ø°Ù Ø£ÙŠ Ø±ÙˆØ§Ø¨Ø· ØªØ´ÙŠØ± Ø¥Ù„ÙŠÙ‡ (Ø£ÙŠ Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ø±)
        links.forEach((set, s) => {
            if (set.has(id)) { set.delete(id); if (set.size === 0) links.delete(s); }
        });
        updateLinksDrawing();
        generateCode();
        logToConsole("Disconnected links for selected block", 'status');
    }
}

/* -------------------------
   Ø±ÙˆØ§Ø¨Ø· & Ø§Ù„ØªÙ‚Ø·ÙŠØ¹ (snapping)
   ------------------------- */
function addLink(sourceID, targetID){
    if (!sourceID || !targetID) return;
    if (!links.has(sourceID)) links.set(sourceID, new Set());
    links.get(sourceID).add(targetID);
}

function removeLinkPair(sourceID, targetID){
    if (!links.has(sourceID)) return;
    const s = links.get(sourceID);
    s.delete(targetID);
    if (s.size === 0) links.delete(sourceID);
}

function snapAndLink(moving, others){
    let snapped = false;
    let closestSnap = {dist: SNAP+1, other: null, type: null};

    others.forEach(fixed => {
        if (fixed === moving) return;
        const rm = getRect(moving), rf = getRect(fixed);
        let currentDist;

        // vertical: bottom of fixed -> top of moving (align left)
        if (Math.abs(rm.left - rf.left) < SNAP/2){
            currentDist = Math.abs(rm.top - rf.bottom);
            if (currentDist < SNAP && currentDist < closestSnap.dist){
                closestSnap = {dist: currentDist, other: fixed, type: 'vertical'};
            }
        }

        // horizontal: right of fixed -> left of moving (align top)
        if (Math.abs(rm.top - rf.top) < SNAP/2){
            currentDist = Math.abs(rm.left - rf.right);
            if (currentDist < SNAP && currentDist < closestSnap.dist){
                closestSnap = {dist: currentDist, other: fixed, type: 'horizontal'};
            }
        }
    });

    if (closestSnap.other){
        const fixed = closestSnap.other;
        const rf = getRect(fixed);

        if (closestSnap.type === 'vertical'){
            moving.style.left = px(rf.left);
            moving.style.top = px(rf.bottom);
            addLink(getID(fixed), getID(moving));
            snapped = true;
        } else if (closestSnap.type === 'horizontal'){
            moving.style.left = px(rf.right);
            moving.style.top = px(rf.top);
            addLink(getID(fixed), getID(moving));
            snapped = true;
        }

        const now = Date.now();
        if (snapped && now - lastSnapTime > DEBOUNCE_TIME){
            try { stickSound.currentTime = 0; stickSound.play(); } catch(e){ /* ignore */ }
            lastSnapTime = now;
        }
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ù„ØµÙ‚ØŒ Ù†Ø­Ø°Ù Ø£ÙŠ Ø±ÙˆØ§Ø¨Ø· Ø®Ø§Ø±Ø¬Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø¨Ø¹
        links.delete(getID(moving));
    }

    updateLinksDrawing();
    return snapped;
}

/* -------------------------
   Ø±Ø³Ù… Ø§Ù„Ø±ÙˆØ§Ø¨Ø· updateLinksDrawing
   ------------------------- */
function updateLinksDrawing(){
    document.querySelectorAll('.link-line').forEach(l=>l.remove());

    links.forEach((targetsSet, sourceID) => {
        const source = document.getElementById(sourceID);
        if (!source) return;
        targetsSet.forEach(targetID => {
            const target = document.getElementById(targetID);
            if (!target) return;

            const rs = getRect(source), rt = getRect(target);
            const line = document.createElement('div');
            line.className = 'link-line';

            let x1,y1,x2,y2,angle,length;
            // if vertical aligned
            if (Math.abs(rs.left - rt.left) < SNAP/2 && rt.top > rs.bottom){
                x1 = rs.left + rs.width/2; y1 = rs.bottom;
                x2 = rt.left + rt.width/2; y2 = rt.top;
            } else if (Math.abs(rs.top - rt.top) < SNAP/2 && rt.left > rs.right){
                x1 = rs.right; y1 = rs.top + rs.height/2;
                x2 = rt.left; y2 = rt.top + rt.height/2;
            } else {
                const cs = getCenter(source), ct = getCenter(target);
                x1 = cs.x; y1 = cs.y;
                x2 = ct.x; y2 = ct.y;
            }

            const dx = x2 - x1, dy = y2 - y1;
            length = Math.hypot(dx, dy);
            angle = Math.atan2(dy, dx);

            line.style.width = px(length);
            line.style.height = px(2);
            line.style.boxShadow = '0 0 12px #ffffffee';
            line.style.transform = `rotate(${angle}rad)`;
            line.style.transformOrigin = '0 0';
            line.style.left = px(x1);
            line.style.top = px(y1 - 1.5);

            stage.appendChild(line);
        });
    });
}

/* -------------------------
   Events: pointerdown/move/up and selection box
   ------------------------- */

function onDown(e, el){
    if (el.contentEditable === "true" || el.classList.contains('editing')) return;
    e.preventDefault();

    // Ctrl+click to link selected -> clicked (Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯)
    if (window._ctrlKey && selectedBoxes.length === 1 && selectedBoxes[0] !== el){
        addLink(getID(selectedBoxes[0]), getID(el));
        updateLinksDrawing();
        generateCode();
        logToConsole(`Linked ${selectedBoxes[0].textContent} -> ${el.textContent}`, 'status');
        return;
    }

    dragging = el;

    if (window._shiftKey){
        if (!selectedBoxes.includes(el)) selectBox(el);
    } else {
        if (!selectedBoxes.includes(el)){ clearSelection(); selectBox(el); }
    }

    const r = stage.getBoundingClientRect();
    if (selectedBoxes.length > 1){
        groupOffsets = selectedBoxes.map(box => {
            const pos = getPos(box);
            return {el: box, dx: (e.clientX - r.left) - pos.x, dy: (e.clientY - r.top) - pos.y};
        });
    } else {
        const pos = getPos(el);
        singleOffset = {x: (e.clientX - r.left) - pos.x, y: (e.clientY - r.top) - pos.y};
    }
}

function onMove(e){
    if (dragging){
        const r = stage.getBoundingClientRect();
        const currentX = e.clientX - r.left;
        const currentY = e.clientY - r.top;

        if (selectedBoxes.length > 1){
            selectedBoxes.forEach((box, i) => {
                const off = groupOffsets[i];
                box.style.left = px(currentX - off.dx);
                box.style.top = px(currentY - off.dy);
            });
            snapAndLink(dragging, boxes.filter(b => !selectedBoxes.includes(b)));
        } else {
            dragging.style.left = px(currentX - singleOffset.x);
            dragging.style.top = px(currentY - singleOffset.y);
            snapAndLink(dragging, boxes.filter(b => b !== dragging));
        }

        generateCode();
    } else if (isSelecting && selectionBox){
        const r = stage.getBoundingClientRect();
        const x = e.clientX - r.left, y = e.clientY - r.top;
        const left = Math.min(x, selectionStart.x), top = Math.min(y, selectionStart.y);
        const width = Math.abs(x - selectionStart.x), height = Math.abs(y - selectionStart.y);

        selectionBox.style.left = px(left);
        selectionBox.style.top = px(top);
        selectionBox.style.width = px(width);
        selectionBox.style.height = px(height);

        boxes.forEach(b => {
            const bp = getPos(b);
            const bx2 = bp.x + b.offsetWidth;
            const by2 = bp.y + b.offsetHeight;
            if (bx2 > left && bp.x < left + width && by2 > top && bp.y < top + height){
                selectBox(b);
            } else if (!window._shiftKey){
                b.classList.remove('selected');
                selectedBoxes = selectedBoxes.filter(x => x !== b);
            }
        });
        updateInspector();
    }
}

function onUp(e){
    if (dragging){
        snapAndLink(dragging, boxes.filter(b => b !== dragging));
    }
    dragging = null;
    isSelecting = false;
    if (selectionBox){ stage.removeChild(selectionBox); selectionBox = null; }
}

stage.addEventListener('pointerdown', e => {
    if (e.target.closest('.square')) return;
    if (e.target.closest('.controls-bar')) return;

    if (!window._shiftKey && !window._ctrlKey) clearSelection();

    isSelecting = true;
    const r = stage.getBoundingClientRect();
    selectionStart = {x: e.clientX - r.left, y: e.clientY - r.top};
    selectionBox = document.createElement('div');
    selectionBox.className = 'selection-box';
    selectionBox.style.left = px(selectionStart.x);
    selectionBox.style.top = px(selectionStart.y);
    stage.appendChild(selectionBox);
});

window.addEventListener('pointermove', onMove);
window.addEventListener('pointerup', onUp);

window.addEventListener('keydown', e => {
    if (e.key === "Shift") window._shiftKey = true;
    if (e.key === "Control") window._ctrlKey = true;
    if (e.key === "Delete" && !document.activeElement.isContentEditable) deleteSelected();
    if (e.key === "a" && (e.ctrlKey || e.metaKey)){ e.preventDefault(); selectAll(); }
});
window.addEventListener('keyup', e => {
    if (e.key === "Shift") window._shiftKey = false;
    if (e.key === "Control") window._ctrlKey = false;
});

/* -------------------------
   Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ (setupBox)
   ------------------------- */
function setupBox(el){
    getID(el);
    el.addEventListener('pointerdown', e => onDown(e, el));
    el.addEventListener('dblclick', () => { clearSelection(); selectBox(el); startEditing(el); });
    el.addEventListener('click', e => {
        if (!window._shiftKey && !window._ctrlKey) { clearSelection(); selectBox(el); }
        else if (window._shiftKey) {
            if (selectedBoxes.includes(el)){ clearSelection(); selectBox(el); }
            else selectBox(el);
        }
        e.stopPropagation();
    });
    el.addEventListener("input", () => autoResize(el));
    autoResize(el);
}

/* initial setup of existing boxes */
boxes.forEach(setupBox);

/* -------------------------
   Ø£Ø¯ÙˆØ§Øª (Add/Delete/SelectAll/Screenshot)
   ------------------------- */
window.addBox = function(){
    const newBox = document.createElement('div');
    newBox.className = 'square';
    newBox.dataset.type = 'process';
    newBox.style.left = "400px";
    newBox.style.top = "100px";
    newBox.textContent = "new process";
    stage.appendChild(newBox);
    boxes.push(newBox);
    setupBox(newBox);
    logToConsole("Added new block", 'status');
};

window.selectAll = function(){
    clearSelection();
    boxes.forEach(b => selectBox(b));
};

window.deleteSelected = function(){
    selectedBoxes.forEach(b => {
        if (stage.contains(b)){
            const id = getID(b);
            // Ø­Ø°Ù Ø£ÙŠ Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø±
            links.delete(id);
            // Ø­Ø°Ù Ø£ÙŠ Ø±ÙˆØ§Ø¨Ø· ØªØ´ÙŠØ± Ø¥Ù„ÙŠÙ‡
            links.forEach((set, s) => {
                if (set.has(id)) {
                    set.delete(id);
                    if (set.size === 0) links.delete(s);
                }
            });
            stage.removeChild(b);
            boxes = boxes.filter(x => x !== b);
        }
    });
    selectedBoxes = [];
    updateLinksDrawing();
    generateCode();
    logToConsole("Deleted selected blocks", 'status');
};

window.takeShot = function(){
    const prev = inspectorPanel.style.display;
    inspectorPanel.style.display = 'none';
    html2canvas(document.body, {backgroundColor: null}).then(canvas => {
        const link = document.createElement('a');
        link.download = 'algorithms_stick_workspace.png';
        link.href = canvas.toDataURL();
        link.click();
        inspectorPanel.style.display = prev;
    }).catch(err => logToConsole("Screenshot error: " + err.message, 'error'));
    logToConsole("Screenshot taken", 'status');
};

/* -------------------------
   Serialization (save/load/export/import)
   ------------------------- */
function serializeWorkspace(){
    // convert links Map<source, Set<targets>> -> array of [source, target]
    const linksArray = [];
    links.forEach((set, s) => {
        set.forEach(t => linksArray.push([s, t]));
    });

    return {
        boxes: boxes.map(box => ({
            id: getID(box),
            type: box.dataset.type,
            text: box.textContent,
            x: getPos(box).x,
            y: getPos(box).y,
            w: box.offsetWidth,
            h: box.offsetHeight
        })),
        links: linksArray,
        currentID: currentID
    };
}

function deserializeWorkspace(data){
    // remove old boxes
    boxes.forEach(b => stage.contains(b) && stage.removeChild(b));
    boxes = [];
    links.clear();
    currentID = data.currentID || 0;

    data.boxes.forEach(bData => {
        const nb = document.createElement('div');
        nb.className = 'square';
        nb.id = bData.id;
        nb.dataset.type = bData.type || 'process';
        nb.textContent = bData.text;
        nb.style.left = px(bData.x);
        nb.style.top = px(bData.y);
        nb.style.width = px(bData.w);
        nb.style.height = px(bData.h);
        stage.appendChild(nb);
        boxes.push(nb);
        setupBox(nb);
    });

    (data.links || []).forEach(([s,t]) => addLink(s,t));
    clearSelection();
    updateLinksDrawing();
    generateCode();
    logToConsole("Workspace loaded", 'status');
}

window.saveWorkspace = function(){
    try{
        localStorage.setItem('algorithms_stick_workspace', JSON.stringify(serializeWorkspace()));
        logToConsole("Saved to localStorage", 'status');
    } catch(e){ logToConsole("Save error: " + e.message, 'error'); }
};

window.loadWorkspace = function(){
    try{
        const d = localStorage.getItem('algorithms_stick_workspace');
        if (d) deserializeWorkspace(JSON.parse(d));
        else logToConsole("No saved workspace found", 'error');
    } catch(e){ logToConsole("Load error: " + e.message, 'error'); }
};

window.exportJSON = function(){
    const data = JSON.stringify(serializeWorkspace(), null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'algorithms_stick_flow.json';
    a.click();
    URL.revokeObjectURL(url);
    logToConsole("Exported JSON", 'status');
};

window.importJSON = function(event){
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try{
            const data = JSON.parse(e.target.result);
            deserializeWorkspace(data);
            logToConsole("Imported JSON", 'status');
        } catch(err){
            logToConsole("Import error: " + err.message, 'error');
        }
    };
    reader.readAsText(file);
};

/* -------------------------
   Save Project with Screenshot functionality
   ------------------------- */
window.openSaveModal = function() {
    projectNameInput.value = `Project_${new Date().getTime()}`;
    saveModal.style.display = 'flex';
    projectNameInput.focus();
};

// Handle save project
saveProjectBtn.addEventListener('click', function() {
    const projectName = projectNameInput.value.trim();
    if (!projectName) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
        return;
    }
    
    // Hide inspector panel for screenshot
    const prevDisplay = inspectorPanel.style.display;
    inspectorPanel.style.display = 'none';
    
    // Create screenshot
    html2canvas(stage, {backgroundColor: null}).then(canvas => {
        // Restore inspector panel
        inspectorPanel.style.display = prevDisplay;
        
        // Get thumbnail data URL
        const thumbnailCanvas = document.createElement('canvas');
        thumbnailCanvas.width = 100;
        thumbnailCanvas.height = 60;
        const ctx = thumbnailCanvas.getContext('2d');
        
        // Draw resized thumbnail
        ctx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, 100, 60);
        const thumbnailData = thumbnailCanvas.toDataURL('image/png');
        
        // Prepare project data
        const projectData = {
            name: projectName,
            date: new Date().toISOString(),
            workspace: serializeWorkspace(),
            thumbnail: thumbnailData
        };
        
        // Save to localStorage
        const projects = JSON.parse(localStorage.getItem('algorithms_stick_projects') || '[]');
        projects.push(projectData);
        localStorage.setItem('algorithms_stick_projects', JSON.stringify(projects));
        
        // Close modal and update projects list
        saveModal.style.display = 'none';
        loadProjectsList();
        logToConsole(`Project "${projectName}" saved successfully`, 'status');
        alert(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ "${projectName}" Ø¨Ù†Ø¬Ø§Ø­!`);
    }).catch(err => {
        inspectorPanel.style.display = prevDisplay;
        logToConsole("Screenshot error: " + err.message, 'error');
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØºØ±Ø©');
    });
});

// Handle cancel
cancelSaveBtn.addEventListener('click', function() {
    saveModal.style.display = 'none';
});

// Close modal when clicking outside
saveModal.addEventListener('click', function(e) {
    if (e.target === saveModal) {
        saveModal.style.display = 'none';
    }
});

/* -------------------------
   Load Projects List
   ------------------------- */
function loadProjectsList() {
    const projects = JSON.parse(localStorage.getItem('algorithms_stick_projects') || '[]');
    myProjectsList.innerHTML = '';
    
    if (projects.length === 0) {
        myProjectsList.innerHTML = '<li style="color:#666; font-size:10px; text-align:center; padding:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯</li>';
        return;
    }
    
    // Sort by date (newest first)
    projects.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    projects.forEach((project, index) => {
        const li = document.createElement('li');
        li.className = 'project-item';
        li.innerHTML = `
            <div class="project-title">${project.name}</div>
            <div class="project-thumb" style="background-image:url('${project.thumbnail}')"></div>
            <button class="project-load-btn" onclick="loadProject(${index})">ÙØªØ­</button>
            <button class="project-delete-btn" onclick="deleteProject(${index})">Ø­Ø°Ù</button>
        `;
        myProjectsList.appendChild(li);
    });
}

window.loadProject = function(index) {
    const projects = JSON.parse(localStorage.getItem('algorithms_stick_projects') || '[]');
    if (projects[index]) {
        deserializeWorkspace(projects[index].workspace);
        logToConsole(`Project "${projects[index].name}" loaded`, 'status');
    }
};

window.deleteProject = function(index) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ')) {
        const projects = JSON.parse(localStorage.getItem('algorithms_stick_projects') || '[]');
        projects.splice(index, 1);
        localStorage.setItem('algorithms_stick_projects', JSON.stringify(projects));
        loadProjectsList();
        logToConsole('Project deleted', 'status');
    }
};

/* -------------------------
   Utility: getOutgoingLinks(sourceID) => array of target elements
   ------------------------- */
function getOutgoingTargets(sourceID){
    const results = [];
    if (!links.has(sourceID)) return results;
    links.get(sourceID).forEach(t => results.push(t));
    return results;
}

/* -------------------------
   Traversal & Code Generation
   ------------------------- */

/**
 * traverse(elElement, visitedSet, linesArray, indent)
 */
function traverse(el, visited, lines, indent = "    "){
    if (!el) return;
    const id = getID(el);
    if (visited.has(id)) return;
    visited.add(id);

    const type = el.dataset.type;
    const text = el.textContent.trim();

    // skip some meta blocks in output
    if (type === 'start' || type === 'algorithm' || type === 'variable' || type === 'constant'){
        // do nothing for these types as main flow lines (they are handled elsewhere)
    } else if (type === 'read'){
        const varName = (text.split(':')[1] || text).trim() || 'inputVar';
        lines.push(`${indent}${varName} = parseInt(prompt('Enter value for ${varName}:'));`);
    } else if (type === 'write'){
        const output = (text.split(':')[1] || text).trim() || 'output';
        lines.push(`${indent}console.log('Output:', ${output});`);
    } else if (type === 'process'){
        lines.push(`${indent}${text};`);
    } else if (type === 'end'){
        const maybe = (text.split(':')[1] || '').trim();
        lines.push(maybe ? `${indent}return ${maybe};` : `${indent}return;`);
        return; // end traversal
        
    } else if (type === 'decision_if' || type === 'decision'){
        // decision text should be the condition itself (e.g. x < 10)
        const condition = text || '/* condition */';
        // all outgoing links from this decision
        const outs = getOutgoingTargets(id);
        // interpret first linked target as true-branch, second as false-branch (if provided)
        const trueTarget = outs[0] ? document.getElementById(outs[0]) : null;
        const falseTarget = outs[1] ? document.getElementById(outs[1]) : null;

        lines.push(`${indent}if (${condition}) {`);
        if (trueTarget) traverse(trueTarget, visited, lines, indent + "    ");
        else lines.push(indent + "    " + "// no true-path linked");
        lines.push(`${indent}}`);

        if (falseTarget){
            lines.push(`${indent}else {`);
            traverse(falseTarget, visited, lines, indent + "    ");
            lines.push(`${indent}}`);
        }
        // do NOT continue linear traversal automatically here
        return;
    } else if (type === 'decision_else'){
        // an else-block by itself: render its content (used when a decision points to this node as false-branch)
        lines.push(`${indent}// else branch`);
        // continue traversal from this else block to its outgoing (first)
        const outs = getOutgoingTargets(id);
        if (outs.length > 0){
            const nextEl = document.getElementById(outs[0]);
            if (nextEl) traverse(nextEl, visited, lines, indent);
        }
        return;
    } else if (type === 'loop'){ 
        const forStatement = text || '/* initialization; condition; increment */';
        const outs = getOutgoingTargets(id);

        lines.push(`${indent}for (${forStatement}) {`);
        
        const loopBodyTarget = outs[0] ? document.getElementById(outs[0]) : null;

        if (loopBodyTarget) {
            // Ù…Ù†Ø¹ Ø§Ù„Ø¬Ø³Ù… Ù…Ù† ÙØªØ­ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¹Ø§Ù…
            traverse(loopBodyTarget, new Set(visited), lines, indent + "    ");
        } else {
            lines.push(indent + "    " + "// Loop body (no path linked)");
        }
        
        lines.push(`${indent}}`);

        // Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø°ÙŠ ÙŠØ£ØªÙŠ Ø¨Ø¹Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ù„Ù‚Ø©
        const exitTarget = outs[1] ? document.getElementById(outs[1]) : null;
        if (exitTarget) {
            lines.push(`${indent}// Continue after loop`);
            traverse(exitTarget, visited, lines, indent);
        }

        return;
    }

    // continue to next by finding a single outgoing link (first one)
    const outs = getOutgoingTargets(id);
    if (outs.length > 0){
        const nextEl = document.getElementById(outs[0]);
        if (nextEl) traverse(nextEl, visited, lines, indent);
    }
}

/* generateCode uses traverse and produces JS-like output */
function generateCode(){
    let code = '';
    const startBlock = boxes.find(b => b.dataset.type === 'start');
    const algorithmBlock = boxes.find(b => b.dataset.type === 'algorithm');
    const varBlocks = boxes.filter(b => b.dataset.type === 'variable');
    const constBlocks = boxes.filter(b => b.dataset.type === 'constant');

    const variables = varBlocks.map(b => (b.textContent.trim().split("=")[0]||'').trim()).filter(Boolean);
    const constants = constBlocks.map(b => b.textContent.trim()).filter(Boolean);

    if (!algorithmBlock){
        codeOutput.textContent = "/* Error: 'algorithm' block not found */";
        return;
    }

    const algName = (algorithmBlock.textContent.split(':')[1] || '').trim() || 'main';

    code += `// Generated by Algorithms lego V3\n`;
    code += `// ${algorithmBlock.textContent.trim()}\n\n`;
    code += `function ${algName}() {\n\n`;

    if (constants.length > 0){
        code += `    // Constants\n`;
        constants.forEach(c => {
            const parts = c.split("=");
            if (parts.length === 2) code += `    const ${parts[0].trim()} = ${parts[1].trim()};\n`;
        });
        code += `\n`;
    }

    if (variables.length > 0){
        code += `    // Variables\n`;
        code += `    let ${variables.join(", ")};\n\n`;
    }

    if (!startBlock){
        code += `    /* Error: 'start' block not found. Cannot determine execution path. */\n`;
    } else {
        code += `    // Execution Path\n`;
        const visited = new Set();
        const lines = [];
        traverse(startBlock, visited, lines, "    ");
        if (lines.length === 0) code += `    // (no executable blocks found)\n`;
        else lines.forEach(ln => code += ln + '\n');
    }

    code += `\n}\n`;

    codeOutput.textContent = code;
    logToConsole("Code generated", 'status');
}

/* -------------------------
   Initialize
   ------------------------- */
window.addEventListener('load', () => {
    try { loadWorkspace(); } catch(e){ /* ignore */ }
    if (boxes.length > 0) generateCode();
    loadProjectsList(); // Load saved projects
    logToConsole("Algorithms Stick V3 loaded.", 'status');
});

/* expose generateCode globally for buttons that call it */
window.generateCode = generateCode;

})(); // IIFE

// Popup functionality
document.getElementById("closePopup").onclick = function () {
    document.getElementById("popupBackground").style.display = "none";
}

</script>
</body>
</html>